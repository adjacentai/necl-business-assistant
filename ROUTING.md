# Как работает наш бот: от сообщения до ответа

Этот документ простыми словами объясняет, как наш AI-ассистент понимает пользователя и ведет с ним диалог. Вся магия построена на трех китах: **NLU-модель**, **Конечный автомат (FSM)** и **AI-генерация**.

---

### Шаг 1: Пользователь что-то пишет

Все начинается с сообщения от пользователя. Допустим, он пишет:

> "Привет! Посоветуйте букет на день рождения."

---

### Шаг 2: NLU - Понимаем, что от нас хотят

Мы не просто читаем текст, а пытаемся понять его **суть**. Для этого сообщение отправляется в первую AI-модель (GPT) со специальным системным промптом `NLU_SYSTEM_PROMPT`.

**Задача этой модели:** Превратить текст в структурированные данные. Она определяет **намерение** (intent) и извлекает **сущности** (entities).

```text
Сообщение: "Посоветуйте букет на день рождения."
     |
     V
[NLU-модель (GPT)]
     |
     V
JSON-ответ: {"intent": "ask_for_recommendation", "entities": {"occasion": "день рождения"}}
```

Теперь мы знаем, что пользователь хочет **рекомендацию** и повод — **"день рождения"**.

---

### Шаг 3: Маршрутизатор (FSM) - Решаем, что делать дальше

Это мозг нашего бота, функция `route_message` в `src/bot/handlers.py`. Она работает как диспетчер на вокзале: смотрит на `intent` и решает, на какой "путь" (сценарий) направить пользователя.

1.  **Проверка намерения:** Диспетчер видит `intent: "ask_for_recommendation"`. Он знает, что для этого намерения нужно запустить сценарий заказа цветов.

2.  **Проверка сущностей (умный ход!):** Диспетчер проверяет, а не извлекли ли мы уже какую-то полезную информацию? Да! У нас есть `entities: {"occasion": "день рождения"}`.

3.  **Запуск сценария и пропуск шага:** Вместо того чтобы тупо спрашивать "Для какого случая букет?", бот:
    *   Сразу сохраняет "день рождения" в свою временную память (FSM).
    *   **Пропускает первый шаг** и сразу переходит ко второму.
    *   Задает следующий вопрос: "Отлично, подбираем букет... Какой у вас бюджет?"

Если бы пользователь написал просто "Хочу букет", NLU вернул бы `{"intent": "order_flowers", "entities": {}}`. Диспетчер бы это увидел и задал самый первый вопрос: "Для какого случая он нужен?".

---

### Шаг 4: Сценарий (FSM) - Ведем клиента по воронке

Теперь пользователь находится "внутри сценария" `OrderFlowers`. Каждый его следующий ответ будет обрабатываться отдельной, предназначенной для этого шага функцией:

-   `process_occasion` (если его спросили про повод)
-   `process_budget` (когда его спросили про бюджет)
-   `process_preferences` (когда спросили про предпочтения)

На каждом шаге бот сохраняет ответы в память FSM.

---

### Шаг 5: AI-генерация - Создаем персональное предложение

Когда вся информация собрана (повод, бюджет, предпочтения), наступает кульминация.

1.  **Собираем все данные:** Мы берем всю информацию из памяти FSM.
2.  **Формируем детальный промпт:** Создаем новый, очень подробный запрос для второй AI-модели (главной, с ролью "продавца-консультанта").
    ```
    "Сгенерируй предложение букета для клиента со следующими данными:
    - Повод: день рождения
    - Бюджет: 3000 рублей
    - Предпочтения: что-нибудь нежное, в розовых тонах
    Предложи один конкретный, красивый вариант..."
    ```
3.  **Получаем креативный ответ:** AI-продавец генерирует уникальное торговое предложение, например:
    > "Для такого нежного повода я бы порекомендовал наш фирменный букет 'Утренняя роса'. Он состоит из кремовых пионов, розовых ранункулюсов и веточек эвкалипта, что идеально вписывается в ваш бюджет. Как вам такой вариант?"

---

### Шаг 6: Завершение

Пользователь либо соглашается, либо нет. Бот отвечает на это и **очищает свое состояние** (`state.clear()`), завершая сценарий. Теперь он снова готов принимать новые команды и направлять их через маршрутизатор.

### Общая схема

```mermaid
graph TD
    A[Клиент пишет сообщение] --> B{1. NLU-модель (GPT)};
    B --> C{2. Маршрутизатор в handlers.py};
    C -- "Намерение НЕ определено" --> D[Общий ответ от AI];
    C -- "Намерение 'Заказать цветы' + ЕСТЬ сущности" --> F[Шаг 2: Спросить бюджет];
    C -- "Намерение 'Заказать цветы' + НЕТ сущностей" --> E[Шаг 1: Спросить повод];
    E --> F;
    F --> G[Шаг 3: Спросить предпочтения];
    G --> H{4. Собрать все данные и<br/>сформировать детальный промпт};
    H --> I[5. AI-генерация<br/>персонального предложения];
    I --> J{6. Подтверждение от клиента};
    J --> K[Конец сценария / Очистка состояния];
``` 